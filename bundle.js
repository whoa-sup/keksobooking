(()=>{"use strict";(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector(".map__filters-container");let o;const n=()=>{o&&o.remove()};window.card={render:r=>{n();const s=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),c=s.querySelector(".popup__title"),a=r.offer.title;window.util.renderTextContent(a,c);const i=s.querySelector(".popup__text--address"),d=r.offer.address;window.util.renderTextContent(d,i);const l=s.querySelector(".popup__text--price"),u=r.offer.price;window.util.renderTextContent(u,l,u+"₽/ночь");const m=s.querySelector(".popup__type"),p=r.offer.type;window.util.renderTextContent(p,m,e[p]);const f=s.querySelector(".popup__text--capacity"),y=r.offer.rooms,h=r.offer.guests;y&&h?f.textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`:f.remove();const v=s.querySelector(".popup__text--time"),_=r.offer.checkin,w=r.offer.checkout;_&&w?v.textContent=`Заезд после ${r.offer.checkin}, выезд до ${r.offer.checkout}`:v.remove();const E=s.querySelector(".popup__features"),g=r.offer.features;g?(E.innerHTML="",g.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),E.append(t)}))):E.remove();const L=s.querySelector(".popup__description"),S=r.offer.description;window.util.renderTextContent(S,L);const q=s.querySelector(".popup__photos"),x=q.querySelector(".popup__photo"),k=r.offer.photos;k?(q.innerHTML="",k.forEach((e=>{const t=x.cloneNode(!0);t.src=e,q.append(t)}))):q.remove();const M=s.querySelector(".popup__avatar"),T=r.author.avatar;T?M.src=T:M.remove();const b=s.querySelector(".popup__close"),A=e=>{"Escape"===e.key&&(e.preventDefault(),document.removeEventListener("keydown",A),n())};document.addEventListener("keydown",A),b.addEventListener("click",(()=>{n()})),o=s,t.before(s)},remove:n}})(),(()=>{const e={"housing-type":{elem:document.querySelector("#housing-type"),isMatches:function(e){return"any"===this.elem.value||this.elem.value===e.offer.type}},"housing-rooms":{elem:document.querySelector("#housing-rooms"),isMatches:function(e){return"any"===this.elem.value||this.elem.value===e.offer.rooms.toString()}},"housing-guests":{elem:document.querySelector("#housing-guests"),isMatches:function(e){return"any"===this.elem.value||this.elem.value===e.offer.guests.toString()}},"housing-price":{elem:document.querySelector("#housing-price"),map:{low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},isMatches:function(e){return"any"===this.elem.value||e.offer.price>=this.map[this.elem.value].start&&e.offer.price<=this.map[this.elem.value].end}},"housing-features":{checkboxes:document.querySelectorAll('#housing-features input[type="checkbox"]'),isMatches:function(e){let t=!0;for(const o of this.checkboxes)t&&(t=!1===o.checked||e.offer.features.includes(o.value));return t}}};window.filter=t=>{const o=[];for(let n=0;n<t.length;n++)if(o.length<5){let r=!0;for(const o in e)r&&(r=e[o].isMatches(t[n]));r&&o.push(t[n])}return o}})(),(()=>{const e={title:{MIN_LENGTH:30,MAX_LENGTH:100},price:{MAX_VALUE:1e6},type:{minPrice:{bungalow:0,flat:1e3,house:5e3,palace:1e4}},rooms:{capacity:{1:[1],2:[1,2],3:[1,2,3],100:[0]}}},t=document.querySelector(".ad-form"),o=t.querySelector("#room_number"),n=t.querySelector("#capacity"),r=t.querySelector("#type"),s=t.querySelector("#timeout"),c=t.querySelector("#timein"),a=t.querySelector("#title"),i=t.querySelector("#address"),d=t.querySelector("#price"),l=t.querySelector("#avatar"),u=t.querySelector("#images"),m=t.querySelector(".ad-form-header__preview img"),p=t.querySelector(".ad-form__photo"),f=/image\/(jpeg|jpg|png|gif)/;a.required=!0,a.minLength=e.title.MIN_LENGTH,a.maxLength=e.title.MAX_LENGTH,d.required=!0,d.max=e.price.MAX_VALUE;const y=()=>{const t=r.value;d.min=e.type.minPrice[t],d.placeholder=e.type.minPrice[t]};y(),r.addEventListener("change",(()=>{y()})),i.readOnly=!0;const h=(e,t)=>{t.value=e.value};c.addEventListener("change",(()=>{h(c,s)})),s.addEventListener("change",(()=>{h(s,c)})),l.accept=u.accept="image/*";const v=function(e){const t=e.files[0];return new Promise(((e,o)=>{if(t.type.match(f)){const o=new FileReader;o.addEventListener("load",(()=>{e(o.result)})),o.readAsDataURL(t)}else o("Фотография должна быть в формате jpg, png или gif")}))};l.addEventListener("change",(()=>{v(l).then((e=>{m.src=e})).catch(window.message.addError)})),p.style.backgroundSize="contain",u.addEventListener("change",(()=>{v(u).then((e=>{p.style.backgroundImage=`url(${e})`})).catch(window.message.addError)}));const _=()=>{const t=+o.value,r=+n.value;e.rooms.capacity[t].includes(r)?n.setCustomValidity(""):n.setCustomValidity("Выберите другое количество гостей, не превышающее количества комнат")};_(),o.addEventListener("change",(()=>{_()})),n.addEventListener("change",(()=>{_()}))})(),(()=>{const e={AD_FORM_ELEMENTS:[".ad-form",".ad-form fieldset",".ad-form input",".ad-form textarea",".ad-form select",".ad-form button"],MAP_FILTERS_ELEMENTS:[".map__filters input",".map__filters select",".map__filters fieldset"]},t="https://21.javascript.pages.academy/keksobooking/data",o="https://21.javascript.pages.academy/keksobooking",n=document.querySelector(".map"),r=n.querySelector(".map__filters"),s=document.querySelector(".ad-form"),c=s.querySelector(".ad-form__reset"),a=document.querySelectorAll(e.AD_FORM_ELEMENTS.join(", ")),i=document.querySelectorAll(e.MAP_FILTERS_ELEMENTS.join(", ")),d=document.querySelector(".map__pin--main"),l=s.querySelector("#address");let u=!1;const m={minY:130-d.offsetHeight-22,maxY:630-d.offsetHeight-22,minX:0-d.offsetWidth/2,maxX:n.offsetWidth-d.offsetWidth/2},p={left:d.style.left,top:d.style.top},f=e=>{const t=Math.round(d.offsetLeft+d.offsetWidth/2),o=Math.round(d.offsetTop+d.offsetHeight/2),n=Math.round(d.offsetTop+d.offsetHeight);l.value=e?`${t}, ${n+22}`:`${t}, ${o}`},y=e=>{for(const e of i)e.disabled=!1;const t=window.filter(e);window.pins.render(t),n.addEventListener("click",(e=>{const t=e.target,o=t.classList.contains("map__pin"),n=t.classList.contains("map__pin--main"),r=t.parentElement.classList.contains("map__pin"),s=t.parentElement.classList.contains("map__pin--main");n||s||!o&&!r||window.card.render(o?t.data:t.parentElement.data)}));const o=window.util.debounce((()=>{window.pins.remove(),window.card.remove();const t=window.filter(e);window.pins.render(t)}),500);r.addEventListener("change",o)},h=e=>{window.message.addError(e)},v=()=>{u=!1,n.classList.add("map--faded"),s.classList.add("ad-form--disabled");for(const e of a)e.disabled=!0;for(const e of i)e.disabled=!0;s.reset(),r.reset(),d.style.left=p.left,d.style.top=p.top,f(u),window.pins.remove(),window.card.remove(),d.addEventListener("keydown",w),s.removeEventListener("submit",L),c.removeEventListener("click",S)},_=()=>{u=!0,n.classList.remove("map--faded"),s.classList.remove("ad-form--disabled");for(const e of a)e.disabled=!1;window.request.send("GET",t).then(y).catch(h),d.removeEventListener("keydown",w),s.addEventListener("submit",L),c.addEventListener("click",S)},w=e=>{"Enter"===e.key&&(_(),f(u))};d.addEventListener("mousedown",(e=>{e.preventDefault(),0!==e.button||u||_();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();const o=t.x-e.clientX,n=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const r={x:d.offsetLeft-o,y:d.offsetTop-n};r.y=r.y<=m.minY?m.minY:r.y,r.y=r.y>=m.maxY?m.maxY:r.y,r.x=r.x<=m.minX?m.minX:r.x,r.x=r.x>=m.maxX?m.maxX:r.x,d.style.top=r.y+"px",d.style.left=r.x+"px",f(u)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n),f(u)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",n)}));const E=()=>{window.message.addSuccess(),v()},g=()=>{window.message.addError()},L=e=>{e.preventDefault(),window.request.send("POST",o,new FormData(s)).then(E).catch(g)},S=()=>{v()};window.addEventListener("load",(()=>{v()}))})(),(()=>{const e=document.querySelector("main");window.message={addError:t=>{const o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),n=o.querySelector(".error__message"),r=o.querySelector(".error__button");t&&(n.textContent=t),r.addEventListener("click",(()=>{o.remove()}));const s=e=>{window.util.isEscPressed(e,c)},c=()=>{o.remove(),document.removeEventListener("keydown",s)};o.addEventListener("click",(()=>{c()})),document.addEventListener("keydown",s),e.append(o)},addSuccess:()=>{const t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),o=e=>{window.util.isEscPressed(e,n)},n=()=>{t.remove(),document.removeEventListener("keydown",o)};t.addEventListener("click",(()=>{n()})),document.addEventListener("keydown",o),e.append(t)}}})(),(()=>{const e=document.querySelector(".map__pins");window.pins={render:t=>{const o=document.querySelector("#pin").content.querySelector(".map__pin"),n=e=>{if(!e.offer)return!1;const t=o.cloneNode(!0),n=t.querySelector("img");return t.style.left=e.location.x-25+"px",t.style.top=e.location.y-70+"px",n.src=e.author.avatar,n.alt=e.offer.title,t.data=e,t},r=document.createDocumentFragment();for(const e of t)r.append(n(e));e.append(r)},remove:()=>{for(;!e.lastElementChild.classList.contains("map__pin--main");)e.lastChild.remove()}}})(),window.request={send:(e,t,o)=>new Promise(((n,r)=>{const s=new XMLHttpRequest;s.responseType="json",s.open(e,t),s.addEventListener("load",(()=>{200===s.status?n(s.response):r("Статус ответа: "+s.status+" "+s.statusText)})),s.addEventListener("error",(function(){r("Произошла ошибка соединения")})),s.addEventListener("timeout",(function(){r("Запрос не успел выполниться за "+s.timeout+"мс")})),s.timeout=1e4,s.send(o)}))},(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;window.util={debounce:(e,t)=>{let o;return(...n)=>{const r=e.bind(null,...n);clearTimeout(o),o=setTimeout(r,t)}},getRandomNumberFromRange:e,getRandomArrayElement:e=>e[Math.floor(Math.random()*e.length)],shuffleArray:e=>{let t,o;for(let n=e.length-1;n>0;n--)o=Math.floor(Math.random()*(n+1)),t=e[o],e[o]=e[n],e[n]=t;return e},copyArrayRandomElements:t=>t.slice(0,e(0,t.length-1)),renderTextContent:(e,t,o=e)=>{e?t.textContent=o:t.remove()},isEscPressed:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())}}})()})();