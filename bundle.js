(()=>{"use strict";(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector(".map__filters-container"),o=document.querySelector("#card").content.querySelector(".map__card");let n;const r=()=>{n&&n.remove()};window.card={render:s=>{r();const c=o.cloneNode(!0),a=c.querySelector(".popup__title"),i=s.offer.title;window.util.renderTextContent(i,a);const d=c.querySelector(".popup__text--address"),l=s.offer.address;window.util.renderTextContent(l,d);const u=c.querySelector(".popup__text--price"),m=s.offer.price;window.util.renderTextContent(m,u,m+"₽/ночь");const p=c.querySelector(".popup__type"),f=s.offer.type;window.util.renderTextContent(f,p,e[f]);const y=c.querySelector(".popup__text--capacity"),h=s.offer.rooms,v=s.offer.guests;h&&v?y.textContent=`${s.offer.rooms} комнаты для ${s.offer.guests} гостей`:y.remove();const _=c.querySelector(".popup__text--time"),w=s.offer.checkin,E=s.offer.checkout;w&&E?_.textContent=`Заезд после ${s.offer.checkin}, выезд до ${s.offer.checkout}`:_.remove();const g=c.querySelector(".popup__features"),L=s.offer.features;L?(g.innerHTML="",L.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),g.append(t)}))):g.remove();const S=c.querySelector(".popup__description"),q=s.offer.description;window.util.renderTextContent(q,S);const x=c.querySelector(".popup__photos"),k=x.querySelector(".popup__photo"),M=s.offer.photos;M?(x.innerHTML="",M.forEach((e=>{const t=k.cloneNode(!0);t.src=e,x.append(t)}))):x.remove();const b=c.querySelector(".popup__avatar"),T=s.author.avatar;T?b.src=T:b.remove();const A=c.querySelector(".popup__close"),C=e=>{"Escape"===e.key&&(e.preventDefault(),document.removeEventListener("keydown",C),r())};document.addEventListener("keydown",C),A.addEventListener("click",(()=>{r()})),n=c,t.before(c)},remove:r}})(),(()=>{const e={"housing-type":{elem:document.querySelector("#housing-type"),isMatches(e){return"any"===this.elem.value||this.elem.value===e.offer.type}},"housing-rooms":{elem:document.querySelector("#housing-rooms"),isMatches(e){return"any"===this.elem.value||this.elem.value===e.offer.rooms.toString()}},"housing-guests":{elem:document.querySelector("#housing-guests"),isMatches(e){return"any"===this.elem.value||this.elem.value===e.offer.guests.toString()}},"housing-price":{elem:document.querySelector("#housing-price"),map:{low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},isMatches(e){return"any"===this.elem.value||e.offer.price>=this.map[this.elem.value].start&&e.offer.price<=this.map[this.elem.value].end}},"housing-features":{checkboxes:document.querySelectorAll('#housing-features input[type="checkbox"]'),isMatches(e){let t=!0;for(const o of this.checkboxes)t&&(t=!1===o.checked||e.offer.features.includes(o.value));return t}}};window.filter=t=>{const o=[];for(let n=0;n<t.length;n++)if(o.length<5){let r=!0;for(const o in e)r&&(r=e[o].isMatches(t[n]));r&&o.push(t[n])}return o}})(),(()=>{const e={title:{MIN_LENGTH:30,MAX_LENGTH:100},price:{MAX_VALUE:1e6},type:{minPrice:{bungalow:0,flat:1e3,house:5e3,palace:1e4}},rooms:{capacity:{1:[1],2:[1,2],3:[1,2,3],100:[0]}}},t=document.querySelector(".ad-form"),o=t.querySelector("#room_number"),n=t.querySelector("#capacity"),r=t.querySelector("#type"),s=t.querySelector("#timeout"),c=t.querySelector("#timein"),a=t.querySelector("#title"),i=t.querySelector("#address"),d=t.querySelector("#price"),l=t.querySelector("#avatar"),u=t.querySelector("#images"),m=t.querySelector(".ad-form-header__preview img"),p=m.src,f=t.querySelector(".ad-form__photo"),y=/image\/(jpeg|jpg|png|gif)/;a.required=!0,a.minLength=e.title.MIN_LENGTH,a.maxLength=e.title.MAX_LENGTH,d.required=!0,d.max=e.price.MAX_VALUE;const h=()=>{const t=r.value;d.min=e.type.minPrice[t],d.placeholder=e.type.minPrice[t]};r.addEventListener("change",(()=>{h()})),i.readOnly=!0;const v=(e,t)=>{t.value=e.value};c.addEventListener("change",(()=>{v(c,s)})),s.addEventListener("change",(()=>{v(s,c)})),l.accept=u.accept="image/*";const _=function(e){const t=e.files[0];return new Promise((o=>{if(t.type.match(y)){const n=new FileReader;e.setCustomValidity(""),n.addEventListener("load",(()=>{o(n.result)})),n.readAsDataURL(t)}else e.setCustomValidity("Фотография должна быть в формате jpg, png или gif")}))};l.addEventListener("change",(()=>{_(l).then((e=>{m.src=e}))})),f.style.backgroundSize="contain",u.addEventListener("change",(()=>{_(u).then((e=>{f.style.backgroundImage=`url(${e})`}))})),t.addEventListener("reset",(()=>{m.src=p,f.style.backgroundImage=""}));const w=()=>{const t=+o.value,r=+n.value;e.rooms.capacity[t].includes(r)?n.setCustomValidity(""):n.setCustomValidity("Выберите другое количество гостей, не превышающее количества комнат")};o.addEventListener("change",(()=>{w()})),n.addEventListener("change",(()=>{w()})),window.form={check:()=>{w(),h()}}})(),(()=>{const e={AD_FORM_ELEMENTS:[".ad-form",".ad-form fieldset",".ad-form input",".ad-form textarea",".ad-form select",".ad-form button"],MAP_FILTERS_ELEMENTS:[".map__filters input",".map__filters select",".map__filters fieldset"]},t="https://21.javascript.pages.academy/keksobooking/data",o="https://21.javascript.pages.academy/keksobooking",n=document.querySelector(".map"),r=n.querySelector(".map__filters"),s=document.querySelector(".ad-form"),c=s.querySelector(".ad-form__reset"),a=document.querySelectorAll(e.AD_FORM_ELEMENTS.join(", ")),i=document.querySelectorAll(e.MAP_FILTERS_ELEMENTS.join(", ")),d=document.querySelector(".map__pin--main"),l=s.querySelector("#address");let u=!1;const m={minY:130-d.offsetHeight-22,maxY:630-d.offsetHeight-22,minX:0-d.offsetWidth/2,maxX:n.offsetWidth-d.offsetWidth/2},p={left:d.style.left,top:d.style.top},f=e=>{const t=Math.round(d.offsetLeft+d.offsetWidth/2),o=Math.round(d.offsetTop+d.offsetHeight/2),n=Math.round(d.offsetTop+d.offsetHeight);l.value=e?`${t}, ${n+22}`:`${t}, ${o}`},y=e=>{for(const e of i)e.disabled=!1;const t=window.filter(e);window.pins.render(t),n.addEventListener("click",(e=>{const t=e.target,o=t.classList.contains("map__pin"),n=t.classList.contains("map__pin--main"),r=t.parentElement.classList.contains("map__pin"),s=t.parentElement.classList.contains("map__pin--main");n||s||!o&&!r||window.card.render(o?t.data:t.parentElement.data)}));const o=window.util.debounce((()=>{window.pins.remove(),window.card.remove();const t=window.filter(e);window.pins.render(t)}),500);r.addEventListener("change",o)},h=e=>{window.message.addError(e)},v=()=>{u=!1,n.classList.add("map--faded"),s.classList.add("ad-form--disabled");for(const e of a)e.disabled=!0;for(const e of i)e.disabled=!0;s.reset(),window.form.check(),r.reset(),d.style.left=p.left,d.style.top=p.top,f(u),window.pins.remove(),window.card.remove(),d.addEventListener("keydown",w),s.removeEventListener("submit",L),c.removeEventListener("click",S)},_=()=>{u=!0,n.classList.remove("map--faded"),s.classList.remove("ad-form--disabled");for(const e of a)e.disabled=!1;window.request.send("GET",t).then(y).catch(h),d.removeEventListener("keydown",w),s.addEventListener("submit",L),c.addEventListener("click",S)},w=e=>{"Enter"===e.key&&(_(),f(u))};d.addEventListener("mousedown",(e=>{e.preventDefault(),0!==e.button||u||_();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();const o=t.x-e.clientX,n=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const r={x:d.offsetLeft-o,y:d.offsetTop-n};r.y=r.y<=m.minY?m.minY:r.y,r.y=r.y>=m.maxY?m.maxY:r.y,r.x=r.x<=m.minX?m.minX:r.x,r.x=r.x>=m.maxX?m.maxX:r.x,d.style.top=r.y+"px",d.style.left=r.x+"px",f(u)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n),f(u)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",n)}));const E=()=>{window.message.addSuccess(),v()},g=()=>{window.message.addError()},L=e=>{e.preventDefault(),window.request.send("POST",o,new FormData(s)).then(E).catch(g)},S=()=>{v()};window.addEventListener("load",(()=>{v()}))})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__message"),n=o.textContent,r=t.querySelector(".error__button"),s=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);window.message={addError:s=>{o.textContent=s||n,r.addEventListener("click",(()=>{t.remove()}));const c=e=>{window.util.isEscPressed(e,a)},a=()=>{t.remove(),document.removeEventListener("keydown",c)};t.addEventListener("click",(()=>{a()})),document.addEventListener("keydown",c),e.append(t)},addSuccess:()=>{const t=e=>{window.util.isEscPressed(e,o)},o=()=>{s.remove(),document.removeEventListener("keydown",t)};s.addEventListener("click",(()=>{o()})),document.addEventListener("keydown",t),e.append(s)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin");window.pins={render:o=>{const n=e=>{if(!e.offer)return!1;const o=t.cloneNode(!0),n=o.querySelector("img");return o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",n.src=e.author.avatar,n.alt=e.offer.title,o.data=e,o},r=document.createDocumentFragment();for(const e of o)r.append(n(e));e.append(r)},remove:()=>{for(;!e.lastElementChild.classList.contains("map__pin--main");)e.lastChild.remove()}}})(),window.request={send:(e,t,o)=>new Promise(((n,r)=>{const s=new XMLHttpRequest;s.responseType="json",s.open(e,t),s.addEventListener("load",(()=>{200===s.status?n(s.response):r("Статус ответа: "+s.status+" "+s.statusText)})),s.addEventListener("error",(function(){r("Произошла ошибка соединения")})),s.addEventListener("timeout",(function(){r("Запрос не успел выполниться за "+s.timeout+"мс")})),s.timeout=1e4,s.send(o)}))},(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;window.util={debounce:(e,t)=>{let o;return(...n)=>{const r=e.bind(null,...n);clearTimeout(o),o=setTimeout(r,t)}},getRandomNumberFromRange:e,getRandomArrayElement:e=>e[Math.floor(Math.random()*e.length)],shuffleArray:e=>{let t,o;for(let n=e.length-1;n>0;n--)o=Math.floor(Math.random()*(n+1)),t=e[o],e[o]=e[n],e[n]=t;return e},copyArrayRandomElements:t=>t.slice(0,e(0,t.length-1)),renderTextContent:(e,t,o=e)=>{e?t.textContent=o:t.remove()},isEscPressed:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())}}})()})();